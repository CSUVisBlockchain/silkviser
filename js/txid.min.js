$(function(){function t(t){$.ajax({type:"get",async:!0,url:t,success:function(t){$("#s_lastestheight").html(t.height),$("#s_trans").html(t.transactions),$("#s_addrs").html(t.addresses),$("#block_trans").show()},error:function(t){console.log(t.statusText)}})}function a(t){$("#txdetailTable").mask(),$("#coin_glyph").mask(),$("#vinslistTable").mask(),$("#voutslistTable").mask(),$.ajax({type:"get",async:!0,url:t,success:function(t){t&&t.vout.length>0&&t.vout[0].value+0==0&&t.vout.shift(),e(t),$("#txdetailTable").unmask(),$(".moreshow").addClass("tt");var a=!0;$("#optionsRadios1").on("click",function(){a?($(".moreshow").removeClass("tt"),a=!1):($(".moreshow").addClass("tt"),a=!0)}),n(t),$("#vinslistTable").unmask(),r(t),$("#voutslistTable").unmask(),s(t),$("#coin_glyph").unmask()},error:function(t){console.error(t)}}),$("#tokentransferlistTable").mask(),$.ajax({type:"get",async:!0,url:o.url,success:function(t){i(t),$("#tokentransferlistTable").unmask()},error:function(t){console.error(t)}})}function e(t){$("#txid").text(t.txid),$("#blockhash").text(t.blockhash),$("#blockhash_href").attr("href","/block/blockhash.html?hash="+t.blockhash),$("#time").text(cnen_timeformater(t.time)),$("#size").text(t.size+" kb"),$("#confirmations").text(t.confirmations),$("#vins").text(t.vin.length),$("#vouts").text(t.vout.length),$("#totalInput").text(t.valueIn+" SLU"),$("#totalOutput").text(t.valueOut+" SLU");try{t.fees>0?$("#fees").text(t.fees+" SLU"):$("#trfees").hide()}catch(t){console.error(t)}}function n(t){$("#vinslistTable").bootstrapTable({data:t.vin,pagination:!0,pageList:[5,10,25],pageSize:10,columns:[{title:$.i18n.prop("bt-vins"),field:"addr",align:"left",formatter:function(t,a,e){var n="Coinbase.";return a.coinbase||(n="<a href='/address/addr.html?addr="+a.addr+"'>"+a.addr+"</a>&nbsp;&nbsp;",n=n+"<a href='/transaction/txid.html?txid="+a.txid+"'>"+a.value+" SLU["+a.vout+"]</a>"),n}}]}),$("#vinslistTable").removeClass("table-bordered")}function r(t){$("#voutslistTable").bootstrapTable({data:t.vout,pagination:!0,pageList:[5,10,25],num_edge_entries:1,pageSize:10,columns:[{title:$.i18n.prop("bt-vouts"),field:"n",align:"left",formatter:function(t,a,e){var n="Empty output.";try{a.scriptPubKey.addresses&&(n="<a href='/address/addr.html?addr="+a.scriptPubKey.addresses[0]+"'>"+a.scriptPubKey.addresses[0]+"</a>&nbsp;&nbsp;"+a.value,""!=a.spentTxId&&null!=a.spentTxId?n=n+"<a href='/transaction/txid.html?txid="+a.spentTxId+"'>[S]</a>":n+="[U]")}catch(t){console.error(t)}return n}}]}),$("#voutslistTable").removeClass("table-bordered")}function i(t){t.items.length>0?$("#tokentransferlistTable").bootstrapTable({data:t.items,pagination:!0,columns:[{title:$.i18n.prop("bt-from"),field:"from",align:"left",formatter:function(t,a,e){return"<a href='/address/addr.html?addr="+t+"'>"+t+"</a>"}},{title:$.i18n.prop("bt-to"),field:"to",align:"left",formatter:function(t,a,e){return"<a href='/address/addr.html?addr="+t+"'>"+t+"</a>"}},{title:$.i18n.prop("bt-value"),field:"value",align:"left",formatter:function(t,a,e){var n=t;try{n=a.value/10**a.decimals,n+=" "+a.symbol}catch(t){console.error(t)}return n}}]}):($("#tokentransferlistTable").hide(),$("#h4tokentransferlistTable").hide())}function s(t){function a(t){var a=1*t.target.dy,e=t.target.x,n=t.target.y,r=e,i=n-.04*t.target.dy,s=e+a*Math.sin(Math.PI/3),l=n+t.target.dy/2,o=r,d=n+1.04*t.target.dy,u=e,c=n+t.target.dy;return"M"+e+","+n+"L"+r+","+i+"L"+s+","+l+"L"+o+","+d+"L"+u+","+c+"L"+e+","+n}function e(t,a,e,r,i,s,l){var o=t.append("g").attr("class","ring");o.attr("id","coin"+r).attr("transform","translate("+a.x+","+a.y+")").on("mouseover",n).on("mouseout",function(){d3.select("#tipsbox").style("display","none")});var d=d3.arc().startAngle(0).endAngle(2*Math.PI).innerRadius(a.innerRadius).outerRadius(a.outerRadius);o.append("path").attr("d",d).style("fill","white").style("stroke","#ae7c4b").attr("stroke-width","1");var u=o.append("g").attr("class","ring_2");u.append("circle").attr("r",a.innerRadius-.5).style("fill","#e9c598").attr("opacity",function(t,a){return i(e.txfee)}),o.append("path").attr("d",V).style("fill","#b2d9ed"),o.append("path").attr("d",Q).style("fill","#b2d9ed"),u.append("rect").attr("x",-.5).attr("y",-a.innerRadius).attr("height",2*a.innerRadius).attr("width",1).style("fill","#ae7c4b").style("opacity","0.3");var c=u.append("g").attr("class","rect");c.append("rect").attr("x",function(t,a){return-.5*l(e.size)}).attr("y",function(t,a){return-.5*l(e.size)}).attr("width",function(t,a){return l(e.size)}).attr("height",function(t,a){return l(e.size)}).attr("fill","white").style("stroke","#ae7c4b").style("stroke-width",.8);var p=t.append("g").attr("class","tips").attr("id","tipsbox").style("display","none");p.append("rect").attr("class","tips-border").attr("width",200).attr("height",90).attr("rx",10).attr("ry",10),p.append("text").attr("id","tipstext1").attr("class","tips-text blocktextblack").attr("x",10).attr("y",15).text("txid:"),p.append("text").attr("id","tipstext2").attr("class","tips-text blocktextblack").attr("x",10).attr("y",30).text("vin_count:"),p.append("text").attr("id","tipstext3").attr("class","tips-text blocktextblack").attr("x",10).attr("y",45).text("vout_count:"),p.append("text").attr("id","tipstext4").attr("class","tips-text blocktextblack").attr("x",10).attr("y",60).text("txfee:"),p.append("text").attr("id","tipstext5").attr("class","tips-text blocktextblack").attr("x",10).attr("y",75).text("size:")}function n(){try{var a=t;d3.select("#tipstext1").text($.i18n.prop("bt-txid")+": "+a.txid.substring(0,5)+"..."+a.txid.substring(59,64)),d3.select("#tipstext2").text($.i18n.prop("bt-vin_count")+": "+a.vin.length),d3.select("#tipstext3").text($.i18n.prop("bt-vout_count")+": "+a.vout.length),d3.select("#tipstext4").text(function(){var t=a.fees;return(t<0||!t)&&(t=0),$.i18n.prop("bt-txfee")+": "+t+" SLU"}),d3.select("#tipstext5").text($.i18n.prop("bt-size")+": "+a.size+" bytes");var e=J.x+s.left,n=J.y+s.top;d3.select("#tipsbox").attr("transform","translate("+e+","+n+")").style("display","block")}catch(t){console.log(t)}}var r=$("#coin_glyph").width(),i=Math.max(.25*r,150),s={top:.01*i,right:.01*r,bottom:.01*r,left:.01*r,sankeyh:.7*i,sankeyw:.5*r},l=.014*r,o=i,d=t.vin.length,p=t.vout.length;d+p<=4&&(o=.7*i,s.sankeyh=.4*i),d+p<=2&&(o=.6*i,s.sankeyh=.2*i);var y=d3.select("#coin_glyph").append("svg").attr("width",r).attr("height",o).attr("transform","translate("+s.left+",0)"),f=y.append("g").attr("transform","translate(0,0)"),v=y.append("g").attr("class","mainClass").attr("id","mainsvg").attr("transform","translate("+.2*r+","+22*s.top+")"),x=Math.max(d,p),h=Math.min(x,Math.max(u,c));x=6*h;var g=s.sankeyh/(2*h-1),m=d3.sankey().nodeWidth(.1).nodePadding(g).size([s.sankeyw,s.sankeyh]),b=m.link_in(),k=m.link_in_line(),_=m.link_out(),w=m.link_out_line(),M={name:t.txid,value:0,tag:"coin",tag0:!1},L={nodes:[],links:[]},T=d3.max(t.vin,function(t){return null!=t.value&&t.value?t.value:0}),R=d3.min(t.vin,function(t){return null!=t.value&&t.value?t.value:0}),z=d3.max(t.vout,function(t){return null!=t.value&&t.value?t.value:0}),I=d3.min(t.vout,function(t){return null!=t.value&&t.value?t.value:0}),P=Math.max(T,z),S=Math.min(R,I);if(0!=P){var U=d3.scaleLinear().domain([S,P]).range([1,3]);t.vin.sort(function(t,a){return a.value-t.value}),t.vout.sort(function(t,a){return a.value-t.value});var A=d,j=!0,C={};d>u?(C.name=d-u+1,C.value=U(t.vin[u-2].value-1e-8),C.tag="in",C.showdot=!0):u=d;for(let a=0;a<d;a++)if(d>u){A=u;var E={};a<u-1?(t.vin[a].addr?(E.name=t.vin[a].addr,E.value=U(t.vin[a].value),E.actualvalue=t.vin[a].value,E.tag="in",E.tag0=!1):t.vin[a].coinbase?(E.name="Coinbase",E.value=U(0),E.actualvalue=0,E.tag="in",E.tag0=!0):(E.name="Empty",E.value=U(0),E.actualvalue=0,E.tag="in",E.tag0=!0),L.nodes.push(E),L.links.push({source:a,target:A,value:E.value})):j?(j=!1,C.actualvalue=t.vin[a].value):C.actualvalue=C.actualvalue+t.vin[a].value}else{E={};t.vin[a].addr?(E.name=t.vin[a].addr,E.value=U(t.vin[a].value),E.actualvalue=t.vin[a].value,E.tag="in",E.tag0=!1):t.vin[a].coinbase?(E.name="Coinbase",E.value=U(0),E.actualvalue=0,E.tag="in",E.tag0=!0):(E.name="Empty",E.value=U(0),E.actualvalue=0,E.tag="in",E.tag0=!0),L.nodes.push(E),L.links.push({source:a,target:d,value:E.value})}d>u&&(L.nodes.push(C),L.links.push({source:u-1,target:A,value:C.value})),L.nodes.push(M);var K=p,B=!0,D={};p>c?(D.name=p-c+1,D.value=U(1*t.vout[c-2].value-1e-8),D.tag="out",D.showdot=!0):c=p;for(let a=0;a<p;a++)if(p>c){K=c;var F={};a<c-1?(t.vout[a].scriptPubKey.addresses?(F.name=t.vout[a].scriptPubKey.addresses[0],F.value=U(1*t.vout[a].value),F.actualvalue=1*t.vout[a].value,F.tag="out",F.tag0=!1,""!=t.vout[a].spentTxId&&null!=t.vout[a].spentTxId&&(F.spended=!0)):(F.name="Empty",F.value=U(0),F.actualvalue=0,F.tag="out",F.tag0=!0),L.nodes.push(F),L.links.push({source:A,target:A+a+1,value:F.value})):B?(B=!1,D.actualvalue=1*t.vout[a].value):D.actualvalue=D.actualvalue+1*t.vout[a].value}else{F={};t.vout[a].scriptPubKey.addresses?(F.name=t.vout[a].scriptPubKey.addresses[0],F.value=U(1*t.vout[a].value),F.actualvalue=1*t.vout[a].value,F.tag="out",F.tag0=!1,""!=t.vout[a].spentTxId&&null!=t.vout[a].spentTxId&&(F.spended=!0)):(F.name="Empty",F.value=U(0),F.actualvalue=0,F.tag="out",F.tag0=!0),L.nodes.push(F),L.links.push({source:A,target:A+a+1,value:F.value})}if(p>c&&(L.nodes.push(D),L.links.push({source:A,target:A+c,value:D.value})),m.nodes(L.nodes).links(L.links).layout(32),d>u){var O=L.nodes[u-1],H=O.dy*U(O.actualvalue)/O.value;L.nodes[u-1].dy=H}if(p>c){var W=L.nodes[u+c],q=W.dy*U(W.actualvalue)/W.value;L.nodes[u+c].dy=q}f.append("circle").attr("cx",.3*r).attr("cy",6*s.top).attr("r",.006*r).attr("fill","#e1b681"),f.append("text").attr("x",s.left+.3*r).attr("y",7*s.top).text($.i18n.prop("tx_legend1")).style("font-size",l+"px"),f.append("circle").attr("cx",.4*r).attr("cy",6*s.top).attr("r",.006*r-1).attr("fill","none").attr("stroke","#e1b681").attr("stroke-width",1),f.append("circle").attr("cx",.4*r-3).attr("cy",6*s.top).attr("r",.8).attr("fill","#e1b681"),f.append("circle").attr("cx",.4*r).attr("cy",6*s.top).attr("r",.8).attr("fill","#e1b681"),f.append("circle").attr("cx",.4*r+3).attr("cy",6*s.top).attr("r",.8).attr("fill","#e1b681"),f.append("text").attr("x",s.left+.4*r).attr("y",7*s.top).text($.i18n.prop("tx_legend2")).style("font-size",l+"px"),f.append("circle").attr("cx",.5*r).attr("cy",6*s.top).attr("r",.006*r).attr("fill","#fd6f58"),f.append("text").attr("x",s.left+.5*r).attr("y",7*s.top).text($.i18n.prop("tx_legend3")).style("font-size",l+"px"),f.append("circle").attr("cx",.6*r).attr("cy",6*s.top).attr("r",.006*r-1).attr("fill","none").attr("stroke","#fd6f58").attr("stroke-width",1),f.append("circle").attr("cx",.6*r-3).attr("cy",6*s.top).attr("r",.8).attr("fill","#fd6f58"),f.append("circle").attr("cx",.6*r).attr("cy",6*s.top).attr("r",.8).attr("fill","#fd6f58"),f.append("circle").attr("cx",.6*r+3).attr("cy",6*s.top).attr("r",.8).attr("fill","#fd6f58"),f.append("text").attr("x",s.left+.6*r).attr("y",7*s.top).text($.i18n.prop("tx_legend4")).style("font-size",l+"px");var G=L.nodes[A],J={id:"node"+A,x:G.x,y:G.y+G.dy/2+18,outerRadius:.4*G.dy,innerRadius:.32*G.dy},N=d3.scaleLinear().domain([0,x]).range([0,Math.PI]),Q=d3.arc().startAngle(-.5*Math.PI+N(h/2)).endAngle(function(){return-N(h/2)-.5*Math.PI}).innerRadius(J.innerRadius+.6).outerRadius(J.outerRadius-.3),V=d3.arc().startAngle(.5*Math.PI-N(h/2)).endAngle(function(){return N(h/2)+.5*Math.PI}).innerRadius(J.innerRadius+.6).outerRadius(J.outerRadius-.3),X={in_x:J.x-Math.cos(N(h/2))*J.outerRadius,in_up_y:J.y-Math.sin(N(h/2))*J.outerRadius,in_down_y:J.y+Math.sin(N(h/2))*J.outerRadius,out_x:J.x+Math.cos(N(h/2))*J.outerRadius,out_up_y:J.y-Math.sin(N(h/2))*J.outerRadius,out_down_y:J.y+Math.sin(N(h/2))*J.outerRadius},Y=[],Z=[],tt={in_dy:(X.in_down_y-X.in_up_y)/A,out_dy:(X.out_down_y-X.out_up_y)/K},at=0,et=0,nt=0;L.links.forEach(function(t,a){"in"==t.source.tag?(at+=t.dy,Y.push(t)):(et+=t.dy,Z.push(t))}),nt=Math.max(at,et)-Math.min(at,et),Y.sort(function(t,a){return t.ty-a.ty}),Z.sort(function(t,a){return t.sy-a.sy}),Y.forEach(function(t,a){t.tx2=X.in_x,t.dy2=tt.in_dy,t.ty2=X.in_up_y+a*tt.in_dy,1==Y.length&&(t.source.y=t.ty2+.5*t.dy2-.5*t.dy)}),Z.forEach(function(t,a){t.sx2=X.out_x,t.dy2=tt.out_dy,t.sy2=X.out_up_y+a*tt.out_dy,1==Z.length&&(t.target.y=t.sy2+.5*t.dy2-.5*t.target.dy)}),L.nodes.forEach(t=>{at<et?"in"==t.tag&&(t.sourceLinks[0].sy=t.sourceLinks[0].sy-2*nt,t.sourceLinks[0].ty=t.sourceLinks[0].ty):"out"==t.tag&&(t.targetLinks[0].sy=t.targetLinks[0].sy+.8*nt,t.targetLinks[0].ty=t.targetLinks[0].ty-.8*nt)});var rt=0,it=0;v.append("g").selectAll(".link_in").data(Y).enter().append("path").attr("class","link_in").attr("d",function(t){return it=Math.max(it,t.dy),1==Y.length?k(t):b(t)}).attr("fill","#b2d9ed");if(d>u){var st=[],lt=m.link_in_last();st.push(Y[Y.length-1]),v.append("g").selectAll(".pathinputdot").data(st).enter().append("path").attr("class","pathinputdot").attr("d",lt).attr("fill","#b2d9ed")}v.append("g").selectAll(".link_out").data(Z).enter().append("path").attr("class","link_out").attr("d",function(t){return rt=Math.max(rt,t.dy),1==Z.length?w(t):_(t)}).attr("fill","#b2d9ed"),v.append("g").selectAll(".link_marker").data(Z).enter().append("path").attr("class","link_marker").attr("d",function(t){return a(t)}).attr("fill","#b2d9ed").attr("stroke","#b2d9ed");var ot=Math.sin(Math.PI/3)*rt,dt=v.append("g").selectAll(".node").data(L.nodes).enter().append("g").attr("id",function(t,a){return"node"+a}).attr("class","node").attr("transform",function(t){return at<et?"in"==t.tag?"translate("+t.x+","+t.y+")":"translate("+(t.x+.5*rt)+","+t.y+")":"out"==t.tag?"translate("+(t.x+.5*rt)+","+t.y+")":"translate("+t.x+","+t.y+")"});in_max_dy=0,out_max_dy=0;for(var ut=0;ut<L.nodes.length;ut++)"in"==L.nodes[ut].tag?L.nodes[ut].dy>in_max_dy&&(in_max_dy=L.nodes[ut].dy):L.nodes[ut].dy>out_max_dy&&(out_max_dy=L.nodes[ut].dy);var ct=dt.append("g").on("mousedown",function(t){"coin"==t.tag||t.tag0||(top.location.href="/address/addr.html?"+$.param({addr:t.name}))}).append("circle").attr("r",function(t){if(!t.showdot)return t.dy/2}).attr("cx",function(t){return"out"==t.tag?t.dx/2+ot:t.dx/2}).attr("cy",function(t){return t.dy/2}).style("fill",function(t,a){return"in"==t.tag?"#e1b681":"#fd6f58"}).style("opacity",function(t){return t.tag0&&!t.showdot?.5:1});if(dt.append("g").append("text").text(function(t){return t.showdot&&"in"==t.tag?t.name+" inputs, "+t.actualvalue.toFixed(3)+" SLU":t.showdot&&"out"==t.tag?t.actualvalue.toFixed(3)+" SLU, "+t.name+" outputs":t.actualvalue+" SLU"}).attr("x",function(t){return"out"==t.tag?t.dx+ot+1.2*rt:"in"==t.tag?t.dx-it:void 0}).attr("y",function(t){return.175*l+t.dy/2}).attr("text-anchor",function(t){return"in"==t.tag?"end":"out"==t.tag?"start":void 0}).style("font-size",.7*l),d>u){var pt=L.nodes[u-1];v.append("g").append("circle").attr("transform",function(){return"translate("+pt.x+","+pt.y+")"}).attr("r",pt.dy/2).attr("cx",pt.dx/2).attr("cy",pt.dy/2).attr("stroke","#e1b681").attr("stroke-width",Math.min(pt.dy/15,1.5)).attr("fill","none"),v.append("g").append("circle").attr("transform",function(){return"translate("+pt.x+","+pt.y+")"}).attr("r",Math.min(pt.dy/15,1.5)).attr("cx",pt.dx/2).attr("cy",pt.dy/2).style("fill","#e1b681"),v.append("g").append("circle").attr("transform",function(){return"translate("+(pt.x-pt.dy/4)+","+pt.y+")"}).attr("r",Math.min(pt.dy/15,1.5)).attr("cx",pt.dx/2).attr("cy",pt.dy/2).style("fill","#e1b681"),v.append("g").append("circle").attr("transform",function(){return"translate("+(pt.x+pt.dy/4)+","+pt.y+")"}).attr("r",Math.min(pt.dy/15,1.5)).attr("cx",pt.dx/2).attr("cy",pt.dy/2).style("fill","#e1b681")}if(p>c){var yt=L.nodes[u+c];v.append("g").append("circle").attr("transform",function(){return"translate("+(yt.x+.5*rt)+","+yt.y+")"}).attr("r",yt.dy/2).attr("cx",yt.dx/2+ot).attr("cy",yt.dy/2).attr("stroke","#fd6f58").attr("stroke-width",Math.min(yt.dy/15,1.5)).attr("fill","none"),v.append("g").append("circle").attr("transform",function(){return"translate("+(yt.x+.5*rt-yt.dy/4)+","+yt.y+")"}).attr("r",Math.min(yt.dy/15,1.5)).attr("cx",yt.dx/2+ot).attr("cy",yt.dy/2).style("fill","#fd6f58"),v.append("g").append("circle").attr("transform",function(){return"translate("+(yt.x+.5*rt+yt.dy/4)+","+yt.y+")"}).attr("r",Math.min(yt.dy/15,1.5)).attr("cx",yt.dx/2+ot).attr("cy",yt.dy/2).style("fill","#fd6f58"),v.append("g").append("circle").attr("transform",function(){return"translate("+(yt.x+.5*rt)+","+yt.y+")"}).attr("r",Math.min(yt.dy/15,1.5)).attr("cx",yt.dx/2+ot).attr("cy",yt.dy/2).style("fill","#fd6f58")}ct.append("title").text(function(t){if(t.tag0)return $.i18n.prop("title-emptynode");if("coin"==t.tag)return $.i18n.prop("bt-txid")+": "+t.name;if("in"==t.tag)return $.i18n.prop("title-addr")+": "+t.name+"\n"+$.i18n.prop("title-value")+": "+t.actualvalue+" SLU";var a=$.i18n.prop("title-addr")+": "+t.name+"\n"+$.i18n.prop("title-value")+": "+t.actualvalue+" SLU";return t.spended?a+"\n"+$.i18n.prop("title-spented"):a+"\n"+$.i18n.prop("title-unspent")}),$("#"+J.id).hide();var ft=d3.scaleLinear().domain([0,t.max_txfee]).range([.5,1]),vt=d3.scaleLinear().range([.2*J.innerRadius,.8*J.innerRadius]).domain([0,t.max_txsize]);e(v,J,t,0,ft,N,vt)}}var l,o,d=UrlParam.param("txid");d=d.replace(/(^\s*)|(\s*$)/g,""),l=0==datasource?{url:"/jsondata/txid.json",newblock:"/jsondata/indexnew.json"}:{url:weburl+"/tx/"+d,newblock:weburl+"/silkchain/indexnew"},o=0==datasource?{url:"/jsondata/tokentransfer.json"}:{url:weburl+"/tokenTransfer?txHash="+d};var u=7,c=7;t(l.newblock),a(l.url),$("#showhideBtn").bind("click",function(){var t=$("#showhideBtn").text();"显示"==t||"Show"==t?($("#showhideBtn").text($.i18n.prop("btn-hide")),$("#showhideDiv").show()):($("#showhideBtn").text($.i18n.prop("btn-show")),$("#showhideDiv").hide())})});